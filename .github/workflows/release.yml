name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-release:
    name: Build and Publish Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2

      - name: Install server dependencies
        run: bun install --frozen-lockfile

      - name: Install client dependencies
        run: cd client && bun install --frozen-lockfile

      - name: Typecheck
        run: bun run typecheck

      - name: Build client
        run: cd client && bun run build

      - name: Build server bundle
        run: bun build src/main.ts --outdir dist --target bun

      - name: Extract version
        id: version
        env:
          REF_NAME: ${{ github.ref_name }}
        run: echo "version=${REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Build binaries (darwin-arm64)
        run: |
          mkdir -p release/qraftbox-${{ steps.version.outputs.version }}-darwin-arm64/dist
          bun build src/main.ts --compile --target bun-darwin-arm64 \
            --outfile release/qraftbox-${{ steps.version.outputs.version }}-darwin-arm64/qraftbox
          cp -r dist/client release/qraftbox-${{ steps.version.outputs.version }}-darwin-arm64/dist/client
          cd release && tar -czf qraftbox-${{ steps.version.outputs.version }}-darwin-arm64.tar.gz \
            qraftbox-${{ steps.version.outputs.version }}-darwin-arm64

      - name: Build binaries (darwin-x64)
        run: |
          mkdir -p release/qraftbox-${{ steps.version.outputs.version }}-darwin-x64/dist
          bun build src/main.ts --compile --target bun-darwin-x64 \
            --outfile release/qraftbox-${{ steps.version.outputs.version }}-darwin-x64/qraftbox
          cp -r dist/client release/qraftbox-${{ steps.version.outputs.version }}-darwin-x64/dist/client
          cd release && tar -czf qraftbox-${{ steps.version.outputs.version }}-darwin-x64.tar.gz \
            qraftbox-${{ steps.version.outputs.version }}-darwin-x64

      - name: Build binaries (linux-x64)
        run: |
          mkdir -p release/qraftbox-${{ steps.version.outputs.version }}-linux-x64/dist
          bun build src/main.ts --compile --target bun-linux-x64 \
            --outfile release/qraftbox-${{ steps.version.outputs.version }}-linux-x64/qraftbox
          cp -r dist/client release/qraftbox-${{ steps.version.outputs.version }}-linux-x64/dist/client
          cd release && tar -czf qraftbox-${{ steps.version.outputs.version }}-linux-x64.tar.gz \
            qraftbox-${{ steps.version.outputs.version }}-linux-x64

      - name: Build binaries (linux-arm64)
        run: |
          mkdir -p release/qraftbox-${{ steps.version.outputs.version }}-linux-arm64/dist
          bun build src/main.ts --compile --target bun-linux-arm64 \
            --outfile release/qraftbox-${{ steps.version.outputs.version }}-linux-arm64/qraftbox
          cp -r dist/client release/qraftbox-${{ steps.version.outputs.version }}-linux-arm64/dist/client
          cd release && tar -czf qraftbox-${{ steps.version.outputs.version }}-linux-arm64.tar.gz \
            qraftbox-${{ steps.version.outputs.version }}-linux-arm64

      - name: Build npm package
        run: |
          mkdir -p release/npm/dist release/npm/bin
          cp dist/main.js release/npm/dist/
          cp -r dist/client release/npm/dist/client
          cp bin/qraftbox.js release/npm/bin/qraftbox.js
          chmod +x release/npm/bin/qraftbox.js
          node -e "
            const pkg = require('./package.json');
            const npmPkg = {
              name: pkg.name,
              version: pkg.version,
              description: pkg.description,
              license: pkg.license,
              type: 'module',
              main: 'dist/main.js',
              bin: { qraftbox: './bin/qraftbox.js' },
              files: ['dist/**/*', 'bin/**/*'],
              engines: { bun: '>=1.0.0' },
              homepage: pkg.homepage,
              repository: pkg.repository,
            };
            require('fs').writeFileSync(
              'release/npm/package.json',
              JSON.stringify(npmPkg, null, 2) + '\n'
            );
          "
          cd release/npm && npm pack --pack-destination ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          generate_release_notes: true
          files: |
            release/qraftbox-${{ steps.version.outputs.version }}-darwin-arm64.tar.gz
            release/qraftbox-${{ steps.version.outputs.version }}-darwin-x64.tar.gz
            release/qraftbox-${{ steps.version.outputs.version }}-linux-x64.tar.gz
            release/qraftbox-${{ steps.version.outputs.version }}-linux-arm64.tar.gz
            release/qraftbox-*.tgz
